<!DOCTYPE html>
<html lang="en">
   <head>
      <!-- Required meta tags -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <!-- Bootstrap CSS -->
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
      <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.14.2/dist/bootstrap-table.min.css">
      <title>Pokémon BDSP - Roamer Seed Checker</title>
      <style>
         .bd-placeholder-img {
         font-size: 1.125rem;
         text-anchor: middle;
         -webkit-user-select: none;
         -moz-user-select: none;
         -ms-user-select: none;
         user-select: none;
         }
         @media (min-width: 768px) {
         .bd-placeholder-img-lg {
         font-size: 3.5rem;
         }
         }
         .themed-grid-col {
         padding-top: 15px;
         padding-bottom: 15px;
         background-color: rgba(86, 61, 124, .15);
         border: 1px solid rgba(86, 61, 124, .2);
         }
      </style>
   </head>
   <body>
      <!-- Optional JavaScript -->
      <!-- jQuery first, then Popper.js, then Bootstrap JS -->
	  <script src="https://code.jquery.com/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
	  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
	  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
      <script src="https://unpkg.com/bootstrap-table@1.14.2/dist/bootstrap-table.min.js"></script>
      <main role="main">
         <div class="jumbotron">
            <div class="col-sm-8 mx-auto">
               <h1>Pokémon BDSP - Roamer Seed Checker</h1>
			   <div>
			   <p><div class="input-group input-group-sm mb-3">
			   
  <div class="input-group-prepend">
    <span class="input-group-text" id="inputGroup-sizing-sm">Seed 1</span>
  </div>
  <input type="text" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm" id="seedbox1" pattern="^([a-fA-F0-9]+)$" maxlength="8">

  <div class="input-group-prepend">
    <span class="input-group-text" id="inputGroup-sizing-sm">Seed 2</span>
  </div>
  <input type="text" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm" id="seedbox2" pattern="^([a-fA-F0-9]+)$" maxlength="8">
</div><div class="input-group input-group-sm mb-3">
  <div class="input-group-prepend">
    <span class="input-group-text" id="inputGroup-sizing-sm">Seed 3</span>
  </div>
  <input type="text" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm" id="seedbox3" pattern="^([a-fA-F0-9]+)$" maxlength="8">

  <div class="input-group-prepend">
    <span class="input-group-text" id="inputGroup-sizing-sm">Seed 4</span>
  </div>
  <input type="text" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm" id="seedbox4" pattern="^([a-fA-F0-9]+)$" maxlength="8">
</div><div class="input-group input-group-sm mb-3">
			   
  <div class="input-group-prepend">
    <span class="input-group-text" id="inputGroup-sizing-sm">Start Frame</span>
  </div>
  <input type="text" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm" id="startframe" pattern="^([0-9]+)$" maxlength="6" value="0">
</div><div class="input-group input-group-sm mb-3">
			   
  <div class="input-group-prepend">
    <span class="input-group-text" id="inputGroup-sizing-sm">Number of Frames</span>
  </div>
  <input type="text" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm" id="endframe" pattern="^([0-9]+)$" maxlength="6" value="100">
</div><div class="input-group input-group-sm mb-3">
  <div class="input-group-prepend">
    <span class="input-group-text" id="inputGroup-sizing-sm">Delay</span>
  </div>
  <input type="text" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm" id="delay" pattern="^([0-9]+)$" maxlength="6" value="104">
</div>
 <button type="button" class="btn btn-primary" onclick="calculateFrames()">Calculate</button> <button type="button" class="btn btn-primary" onclick="calculateShinyFrame()">Search Next Shiny Frame</button></p>
			   </div>
                 <div class="table-responsive">
                    <table class="table table-striped table-hover" id="seed-table" data-sortable="true" data-search="true" data-show-columns="true" data-show-pagination-switch="true" data-show-fullscreen="true">
                       <thead>
                          <tr>
                             <th scope="col" data-field="Frame" data-sortable="true">Advances</th>
                             <th scope="col" data-field="Shiny" data-sortable="true">Shiny</th>
                             <th scope="col" data-field="HP"  data-sortable="true">HP</th>
                             <th scope="col" data-field="ATK" data-sortable="true">ATK</th>
                             <th scope="col" data-field="DEF" data-sortable="true">DEF</th>
                             <th scope="col" data-field="SPA" data-sortable="true">SPATK</th>
                             <th scope="col" data-field="SPD" data-sortable="true">SPDEF</th>
                             <th scope="col" data-field="SPE" data-sortable="true">SPEED</th>
                             <th scope="col" data-field="Nature" data-sortable="true">Nature</th>
                             <th scope="col" data-field="Ability" data-sortable="true">Ability</th>
                             <th scope="col" data-field="Pid" data-sortable="true">Pid</th>
                             <th scope="col" data-field="EC" data-sortable="true">EC</th>
                          </tr>
                       </thead>
                    </table>
               </div>
            </div>
         </div>
         <script>
            var s0 = 0n
            var s1 = 0n
            
            var s00 = 0n;
            var s01 = 0n;

            function setXSeed(seed1, seed2) {
                s00 = seed1
                s01 = seed2
            }
            
            function nextX() {
                t = s00 & SMASK
                s = s01 >> 32n
                t = (t ^ (t << 11n)) & SMASK
                t = t ^ (t >> 8n)
                t = t ^ (s ^ (s >> 19n))
                s00 = ((s01 & SMASK) << 32n) | (s00 >> 32n)
                s01 = (t << 32n) | (s01 >> 32n)
                return (((t-0x80000000n) % SMASK)) & SMASK
            }
            
			var Nature = ["Hardy", "Lonely", "Brave", "Adamant", "Naughty", "Bold", "Docile", "Relaxed", "Impish", "Lax", "Timid", "Hasty", "Serious", "Jolly", "Naive", "Modest", "Mild", "Quiet", "Bashful", "Rash", "Calm", "Gentle", "Sassy", "Careful", "Quirky"]
            
            function rotl(x, k) {
                var a = x << k 
                a = a & MASK 
                var b = x >> (64n - k)
                return a | b
            }
            
            function next() {
                var res = s0 + s1 
                res = res & MASK 
                s1 = s0 ^ s1 
                s0 = rotl(s0, 24n) ^ s1 ^ ((s1 << 16n) & MASK)
                s1 = rotl(s1, 37n)
                return res >> 32n
            }
            
            function calc_state(s) {
                tmp1 = (0xBF58476D1CE4E5B9n * (s ^ (s >> 30n))) & MASK
                tmp2 = (0x94D049BB133111EBn * (tmp1 ^ (tmp1 >> 27n))) & MASK
                return tmp2 ^ (tmp2 >> 31n) 
            }
            
            function setSeed(x) {
                s0 = calc_state((x + 0x9e3779b97f4a7c15n) & MASK)
                s1 = calc_state((x + 0x3C6EF372FE94F82An) & MASK)
            }
            
            function GetShinyValue(n) {
                return GetShinyXor(n) >>> 4
            }
			
			function GetShinyXor(n) {
				return (n >> 16n) ^ (n&0xFFFFn)
			}
            
			function GetShinyType(pid, tidsid) {
				var p = GetShinyXor(pid);
				var t = GetShinyXor(tidsid);
				if ((p ^ t) <= 0x10)
					return 1;
				return 0;
			}
            
            function getData(seed, idx) {
                setSeed(seed)
                var ec = seed
                var sidtid = next()
                var pid = next()
                var shiny = GetShinyType(pid, sidtid)
                var iv = [-1, -1, -1, -1, -1, -1]
                var i = 0
                while(i < 3) {
                    var s = Number(next()%6n)
                    if (iv[s] == -1) {
                        i += 1
                        iv[s] = 31
                    }
                }
                for(i = 0; i < 6; i++) {
                    if(iv[i] == -1) {
                        iv[i] = Number(next()&31n)
                    }
                }
				var ability = 0;
				var abilityNames = ["1", "2"]
                ability = Number(next()&1n)

				var nature = Number(next()%25n)
                var res = {"Pid": pid, "Shiny": shiny, "HP": iv[0], "ATK": iv[1], "DEF": iv[2], "SPA": iv[3], "SPD": iv[4], "SPE": iv[5], "Nature": Nature[nature], "Ability": ability, "Seed": Number(seed & SMASK), "Index": idx}
                return res
            }

            var MASK = 0xFFFFFFFFFFFFFFFFn
            var SMASK = 0xFFFFFFFFn
            var start = 0
            var end = 100
			
			function advanceFrame(frame) {
				for(var i=0; i<frame; i++) {
					nextX();
				}
			}
			
			var entries = []
			
			function calculateShinyFrame() {
				var str1 = $("#seedbox1").val();
                var str2 = $("#seedbox2").val();
                var str3 = $("#seedbox3").val();
                var str4 = $("#seedbox4").val();
				try {
					seed1 = BigInt("0x"+str1)
                    seed2 = BigInt("0x"+str2)
                    seed3 = BigInt("0x"+str3)
                    seed4 = BigInt("0x"+str4)
				} catch(e) {
					alert("Invalid Seed")
					return;
				}
                
				var minstr = $("#startframe").val();
				start = parseInt(minstr)
				if(isNaN(start)) {
					alert("Invalid Start Frame")
					return;
				}
				var maxstr = $("#endframe").val();
				limit = parseInt(maxstr)
				if(isNaN(end)) {
					alert("Invalid Number of Frames")
					return;
				}
				var delayFrame = $("#delay").val();
				delay = parseInt(delayFrame)
				if(isNaN(end)) {
					alert("Invalid Number of Frames")
					return;
				}
				var data = []
				var result = []
                setXSeed((seed2 << 32n) | seed1, (seed4 << 32n) | seed3)
                start += delay
				advanceFrame(start)
                end = start + limit 
				for(i = start;; i++) {
                    seed = nextX()
					res = getData(seed, i-delay)
					if(res["Shiny"] == 1){
						result.push(res)
						break
					}
				}
				$.each(result, function(idx, res) {
					var row = ({
						Frame: res["Index"],
						HP:  res["HP"],
						ATK: res["ATK"],
						DEF: res["DEF"],
						SPA: res["SPA"],
						SPD: res["SPD"],
						SPE: res["SPE"],
						Shiny: res["Shiny"],
						Nature: res["Nature"],
						Ability: res["Ability"],
                        Pid: res["Pid"].toString(16),
                        EC: res["Seed"].toString(16)
					});
					data.push(row);
				});
				$('#seed-table').bootstrapTable('refreshOptions', {
					"data": data
				});
			}

			function calculateFrames() {
				var str1 = $("#seedbox1").val();
                var str2 = $("#seedbox2").val();
                var str3 = $("#seedbox3").val();
                var str4 = $("#seedbox4").val();
				try {
					seed1 = BigInt("0x"+str1)
                    seed2 = BigInt("0x"+str2)
                    seed3 = BigInt("0x"+str3)
                    seed4 = BigInt("0x"+str4)
				} catch(e) {
					alert("Invalid Seed")
					return;
				}
                
				var minstr = $("#startframe").val();
				start = parseInt(minstr)
				if(isNaN(start)) {
					alert("Invalid Start Frame")
					return;
				}
				var maxstr = $("#endframe").val();
				limit = parseInt(maxstr)
				if(isNaN(end)) {
					alert("Invalid Number of Frames")
					return;
				}
				var delayFrame = $("#delay").val();
				delay = parseInt(delayFrame)
				if(isNaN(end)) {
					alert("Invalid Number of Frames")
					return;
				}
				var data = []
				var result = []
                setXSeed((seed2 << 32n) | seed1, (seed4 << 32n) | seed3)
                start += delay
				advanceFrame(start)
                end = start + limit 
				for(i = start; i < end; i++) {
                    seed = nextX()
					result.push(getData(seed, i-delay))
				}
				$.each(result, function(idx, res) {
					var row = ({
						Frame: res["Index"],
						HP:  res["HP"],
						ATK: res["ATK"],
						DEF: res["DEF"],
						SPA: res["SPA"],
						SPD: res["SPD"],
						SPE: res["SPE"],
						Shiny: res["Shiny"],
						Nature: res["Nature"],
						Ability: res["Ability"],
                        Pid: res["Pid"].toString(16),
                        EC: res["Seed"].toString(16)
					});
					data.push(row);
				});
				$('#seed-table').bootstrapTable('refreshOptions', {
					"data": data
				});
			}

			$('#seed-table').bootstrapTable({});
         </script>
      </main>
      <footer class="footer">
         <div class="container text-muted">
            <div class="footer-notice">
               <p>Webpage created by Lean. Framework used is <a href="https://getbootstrap.com/">Bootstrap</a>. <a href="https://www.discord.gg/d8JuAvg">Pokémon RNG Discord</a></p>
               <p>Feedback or suggestions are welcome. Please contact me via Twitter. <a href="https://twitter.com/LeanYoshi"><span class="fa fa-twitter"></span></a></p>
            </div>
         </div>
      </footer>
   </body>
</html>
